---
title: TIL014 - XRT 실행 모델과 특징1
excerpt: "XRT의 실행 모델"
categories: TIL
tags: xilinx
toc: true
toc_sticky: true
---

## 1. 이미지 다운로드

- v++는 유저 디바이스 코드를 FPGA 비트스트림과 메타데이터 콜렉션(메모리 토폴로지나 IP 인스턴스 등)을 포함한 xclbin 파일로 컴파일한다.
- xclmgmt 드라이버는 xclbin 다운로드를 위해서 ioctl을 준다.
- 드라이버는 xclbin section을 조사하고 FPGA 구조를 프로그래밍하고 메모리 토폴로지를 탐색하고 메모리 매니저를 초기화한다.

## 2. 메모리 관리

- PCIe 베이스의 플랫폼은 XRT Core Library에 정의 된 멀티 스레드/프로세스를 허용하는 메모리 관리를 사용한다.
- 메모리 관리는 리눅스 커널 안에서 동작한다. 
- 드라이버는 DRM GEM을 buffer allocator, buffer mmap support, DMA-BUF export/import 등의 메모리 관리를 위해 사용한다. 이러한 기능등은 드라이버에 의해 내보내진 ioctl을 경유해서 쓸 수 있다.
- PCIe 카드는 다양한 메모리 토폴로지를 동적으로 로딩하는 것을 지원한다.
- xocl에서 하나의 FPGA이미지로부터 다른 디바이스로는 자신만의 메모리 주소 범위를 지니는 하나 이상의 메모리 컨트롤러를 보일 수 있다.
- Linux drm_mm을 메모리 할당에 사용하고, drm_gem 프레임워크가 mmap 핸들링을 위해 사용된다.
- 일반적인 디바이스 메모리는 P2P를 쓰는게 아니면 호스트 CPU에 보이지 않기에, 디바이스 메모리를 지원하는 호스트 메모리 페이지를 mmap 지원을 위해 사용한다.
-  호스트 메모리 페이지와 디바이스 메모리 사이를 동기화 하기 위해서 XDMA/QDMA PCIe memory mapped DMA engine이 사용된다.
- 유저는 sync ioctl을 부른다. DMA를 요청된 방향으로 주기 위해서.
- xocl은 PCIe 호스트 메모리 프릿디를 지원한다. 호스트 메모리의 pinning과 Address Remapper tables 프로그래밍을 지원하는.(Host Memory Access)

## 3. 실행 관리

1. xclbin이 드라이버 compute unit에 의해 로딩되고 실행할 준비가 된다.
2. compute uint은 드라이버 컴포넌트 중 하나인 Kernel Domain Scheduler(KDS)에 의해 통제된다.
3. KDS는 클라이언트 프로세스의 ioctl로부터 온 실행 작업을 큐에 올리고, 이용 가능한 compute unit에 스케줄링한다.
4. KDS는 유저에게 실행 작업이 끝났음을 POSIX poll 매커니즘을 이용해서 비동기적으로 알린다.
5. KDS는 Microblaze soft processor 위에서 돌아가는 하드웨어 스케줄러를 compute unit을 잘 통제하기 위해 사용한다.
   - 하드웨어 스케줄러는 ERT(Embedded Runtime)이라 불린다. ERT는 KDS로부터 요청을 받아서 하드웨어 무순서 큐에 올린다. ERT는 KDS에게 Status Register나 MSI-X 인터럽트로 알린다.
6. compute unit은 xocl에게 작업 완료를 인터럽트로 알린다(poll 모드도 지원).

## 4. 보드 관리

- 데이터 버스 정지 복구, 센서 데이터 수집, AXI 방화벽 모니터링, 클락 스케일링, 파워 측정, 펌웨어 파일(ERT, CMC) 로딩 등은 xclmgmt가 수행한다.
